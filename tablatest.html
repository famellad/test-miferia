<!DOCTYPE html>
<html>
<head>
    <title>Read File</title>
    <script>
        var listDict = {};

        function generateID (name) {
            // Empty string to hold the final ID
            var ID = "";

            // Sanitize the string
            {
            name = name.replace("(", "").replace(")", "");
            name = name.toLowerCase();
            name = name.replace("ñ", "n");
            name = name.replace("á", "a");
            name = name.replace("é", "e");
            name = name.replace("í", "i");
            name = name.replace("ó", "o");
            name = name.replace("ú", "u");
            name = name.replace("ú", "u");
            name = name.replace("ç", "c");
            }

            nameSplit = name.split(" ");

            for (let i = 0; i < nameSplit.length; i++) {
                ID += nameSplit[i];
            }

            listDict.push({key: ID, value: name});

            return ID;
        }

        function addSeparator (value) {
            var c = 0;
            var sepValue = "";

            for (let i = value.length - 1; i >= 0; i--) {
                if (c == 3) {
                    sepValue = "," + sepValue;
                    c = 0;
                }
                else c++;

                sepValue = value[i] + sepValue;
            }

            return sepValue;
        }

        function parsePricing (row, lineElements) {
            // Create new cell to hold data
            var cell = row.insertCell(-1);

            // Write price per unit
            cell.textContent = "$" + addSeparator(lineElements[2]) + " / " + lineElements[1];
        }

        function selectorCell (row, lineElements) {
            // Create new cell to hold data
            var cell = row.insertCell(-1);
            // Create new input element as the selector
            var input = document.createElement("input");
            // Create a span element to hold the unit
            var span = document.createElement("span");

            // Set selector as number and initialize at 0
            input.type = "number";
            input.placeholder = 0;
            input.id = generateID(lineElements[0]);

            // Write unit to span
            span.textContent = lineElements[1];

            // Append elements to cell
            cell.appendChild(input);
            cell.appendChild(span);
        }

        function generateTable (csvLines) {
            // Define where to put the table
            var tl = document.getElementById("tab");

            // Create the table object
            var table = document.createElement("table");
            table.border = 1;
            // TODO define id and other attributes

            // Iterate over csv lines
            for (let i = 0; i < csvLines.length; i++) {
                // Generate a new row object
                var row = table.insertRow(-1);
                
                // Parse the csv line
                lineElements = csvLines[i].split(',');

                // Handle the header the header
                if (lineElements[0][0] == '#') {
                    // Create a cell for the header
                    var cell = row.insertCell(-1);
                    // Merge cells
                    cell.colSpan = 3;
                    // Write cell
                    cell.textContent = lineElements[0].split("#")[1];
                }
                // Handle everything else
                else {
                    // Write name of product
                    var nameCell = row.insertCell(-1);
                    nameCell.textContent = lineElements[0];

                    // Handle the pricing column
                    parsePricing(row, lineElements);

                    // Handle the selection column
                    selectorCell(row, lineElements);
                }
            }

            // Finally add the table to the document
            tl.appendChild(table);
        }

        function readCSV () {
            // Send a request to the server to get the CSV list
            var rawFile = new XMLHttpRequest();
            rawFile.open("GET", "listado.csv", true); // Set as async!
            // When the request state changes...
            rawFile.onreadystatechange = function () {
                if (rawFile.readyState === 4) {
                    if (rawFile.status === 200 || rawFile.status == 0) {
                        // Dump the entire file into a variable
                        var allText = rawFile.responseText;
                        // Split by lines into an array
                        var textLines = allText.split("\n");
                        // Generate the table
                        generateTable(textLines);
                    }
                }
            }
            // Close the server connection
            rawFile.send(null);
        }

        readCSV();
    </script>
</head>
<body>
    <div id="tab"></div>
</body>
</html>